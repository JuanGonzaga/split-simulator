<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPLIT - Simulador Tecnico Completo</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          borderRadius: { '2xl': '1rem' }
        }
      }
    }
  </script>
  
  <style>
html, body { background: #fafafa; }
.step-card { 
  transition: transform 0.2s ease, box-shadow 0.2s ease; 
  height: 100%;
  display: flex;
  flex-direction: column;
}
.step-card:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1); 
}
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
  align-items: stretch;
}
@media (min-width: 768px) {
  .cards-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media (min-width: 1024px) {
  .cards-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}
.progress-bar { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
const { useMemo, useState } = React;

const tones = {
  zinc:    { bg: "bg-zinc-100",    text: "text-zinc-800",    pill: "bg-zinc-200 text-zinc-700" },
  emerald: { bg: "bg-emerald-100", text: "text-emerald-800", pill: "bg-emerald-500 text-white" },
  sky:     { bg: "bg-sky-100",     text: "text-sky-800",     pill: "bg-sky-500 text-white" },
  amber:   { bg: "bg-amber-50",    text: "text-amber-700",   pill: "bg-amber-500 text-white" },
  red:     { bg: "bg-red-50",      text: "text-red-700",     pill: "bg-red-500 text-white" },
  purple:  { bg: "bg-purple-50",   text: "text-purple-700",  pill: "bg-purple-500 text-white" }
};

const Badge = ({ children, tone="zinc" }) => {
  const t = tones[tone] || tones.zinc;
  return <span className={`inline-flex items-center px-2 py-0.5 text-xs rounded-full ${t.bg} ${t.text}`}>{children}</span>;
};

const Section = ({ title, subtitle, children }) => (
  <div className="bg-white/70 backdrop-blur p-4 md:p-6 rounded-2xl shadow-sm border border-zinc-200">
    <div className="flex items-center gap-2 mb-2">
      <h2 className="text-lg md:text-xl font-semibold tracking-tight">{title}</h2>
    </div>
    {subtitle && <div className="text-xs text-zinc-500 mb-3">{subtitle}</div>}
    {children}
  </div>
);

const StepCard = ({ step, title, done, ctaLabel, onClick, children, warning, info, error }) => (
  <div className={`p-4 rounded-xl border step-card min-h-[120px] flex flex-col ${done ? "border-emerald-300 bg-emerald-50" : error ? "border-red-300 bg-red-50" : "border-zinc-200 bg-zinc-50"}`}>
    <div className="flex items-center gap-2 mb-3">
      <div className={`w-6 h-6 rounded-full grid place-items-center text-xs font-bold shrink-0 ${done ? "bg-emerald-500 text-white" : error ? "bg-red-500 text-white" : "bg-zinc-200 text-zinc-700"}`}>{step}</div>
      <div className="font-medium text-sm flex-1">{title}</div>
      {done ? <Badge tone="emerald">feito</Badge> : error ? <Badge tone="red">erro</Badge> : <Badge>pendente</Badge>}
    </div>
    
    <div className="flex-1 space-y-2">
      {children}
      {error && <div className="text-red-700 text-xs bg-red-50 border border-red-200 rounded-lg p-2"><strong>ERRO:</strong> {error}</div>}
      {warning && <div className="text-amber-700 text-xs bg-amber-50 border border-amber-200 rounded-lg p-2"><strong>AVISO:</strong> {warning}</div>}
      {info && <div className="text-sky-700 text-xs bg-sky-50 border border-sky-200 rounded-lg p-2"><strong>INFO:</strong> {info}</div>}
    </div>
    
    {onClick && (
      <div className="mt-3 flex justify-end">
        <button
          onClick={onClick}
          className="px-4 py-1.5 rounded-lg bg-zinc-900 text-white text-sm hover:bg-zinc-800 disabled:opacity-50 transition-all"
          disabled={!onClick}
        >
          {ctaLabel}
        </button>
      </div>
    )}
  </div>
);

const Toggle = ({ label, checked, onChange, hint, critical }) => (
  <label className={`flex items-start justify-between gap-3 py-2`}>
    <div>
      <div className={`text-sm font-medium ${critical ? 'text-red-700' : ''}`}>
        {label} {critical && <span className="text-red-500 font-bold">*</span>}
      </div>
      {hint && <div className="text-xs text-zinc-500">{hint}</div>}
    </div>
    <button
      type="button"
      onClick={() => onChange(!checked)}
      className={`relative inline-flex h-6 w-11 items-center rounded-full transition ${checked ? (critical ? "bg-red-500" : "bg-emerald-500") : "bg-zinc-300"}`}
      aria-pressed={checked}
    >
      <span className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${checked ? "translate-x-5" : "translate-x-1"}`} />
    </button>
  </label>
);

const LogRow = ({ ts, label, detail, tone="zinc" }) => {
  const t = tones[tone] || tones.zinc;
  return (
    <div className="grid grid-cols-12 gap-2 text-xs items-baseline">
      <div className="col-span-3 text-zinc-400 tabular-nums">{ts}</div>
      <div className={`col-span-3 font-medium ${t.text}`}>{label}</div>
      <div className="col-span-6 text-zinc-600">{detail}</div>
    </div>
  );
};

const FlowChart = ({ isOpen, onToggle, steps }) => {
  return (
    <div className="bg-white border-b border-zinc-200 shadow-sm">
      <div className="max-w-7xl mx-auto px-4 md:px-8">
        <button
          onClick={onToggle}
          className="w-full py-3 flex items-center justify-between text-left hover:bg-zinc-50 transition-colors"
        >
          <div className="flex items-center gap-3">
            <div className="text-lg font-semibold">Fluxograma do Processo</div>
            <div className="text-sm text-zinc-500">Acompanhe visualmente cada etapa</div>
          </div>
          <div className="text-zinc-400">
            {isOpen ? 'Fechar' : 'Abrir'}
          </div>
        </button>
        
        {isOpen && (
          <div className="pb-6">
            <div className="flex items-center justify-center overflow-x-auto py-4">
              <div className="flex items-center gap-2 min-w-max">
                {steps.map((step, index) => (
                  <React.Fragment key={step.id}>
                    <div className="flex flex-col items-center">
                      <div 
                        className={`relative w-16 h-16 rounded-xl border-2 flex items-center justify-center text-xs font-bold transition-all duration-300 ${
                          step.status === 'completed' 
                            ? 'bg-emerald-500 border-emerald-600 text-white shadow-lg' 
                            : step.status === 'error'
                            ? 'bg-red-500 border-red-600 text-white shadow-lg'
                            : 'bg-zinc-100 border-zinc-300 text-zinc-600'
                        }`}
                      >
                        {step.status === 'completed' ? 'OK' : step.status === 'error' ? 'X' : index + 1}
                      </div>
                      <div className={`mt-2 text-xs font-medium text-center px-2 ${
                        step.status === 'completed' ? 'text-emerald-700' 
                        : step.status === 'error' ? 'text-red-700' 
                        : 'text-zinc-600'
                      }`}>
                        {step.label}
                      </div>
                      {step.subtext && (
                        <div className="text-xs text-zinc-400 text-center mt-1 max-w-20">
                          {step.subtext}
                        </div>
                      )}
                    </div>
                    
                    {index < steps.length - 1 && (
                      <div className={`flex items-center mx-2 ${
                        steps[index + 1].status === 'completed' ? 'text-emerald-500' 
                        : steps[index + 1].status === 'error' ? 'text-red-500' 
                        : 'text-zinc-300'
                      }`}>
                        <div className="w-8 h-0.5 bg-current"></div>
                        <div className="w-2 h-2 border-t-2 border-r-2 border-current rotate-45 -ml-1"></div>
                      </div>
                    )}
                  </React.Fragment>
                ))}
              </div>
            </div>
            
            <div className="text-center text-xs text-zinc-500 mt-4">
              Verde: Concluido - Vermelho: Com erro - Cinza: Pendente
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

function fmtTime(d=new Date()) {
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
}
const rand = () => Math.floor(Math.random()*100000);

function App() {
  const [owner, setOwner] = useState(null);
  const [tenant, setTenant] = useState(null);
  const [property, setProperty] = useState(null);
  const [contract, setContract] = useState(null);
  const [charge, setCharge] = useState(null);
  const [webhook, setWebhook] = useState(null);
  const [repasse, setRepasse] = useState(null);
  
  const [flowChartOpen, setFlowChartOpen] = useState(true);

  const [novoSplitAtivo, setNovoSplitAtivo] = useState(true);
  const [splitSempreCriar, setSplitSempreCriar] = useState(false);
  const [multisplitAtivo, setMultisplitAtivo] = useState(false);

  const [garantiaAtiva, setGarantiaAtiva] = useState(false);
  const [despesaIndevida, setDespesaIndevida] = useState(false);
  const [cpfCnpjObrigatorio, setCpfCnpjObrigatorio] = useState(true);
  const [dadosInvalidos, setDadosInvalidos] = useState(false);
  const [valorBaixo, setValorBaixo] = useState(false);
  const [descontoPontualidade, setDescontoPontualidade] = useState(false);
  const [webhookTimeout, setWebhookTimeout] = useState(false);
  const [splitCancelado, setSplitCancelado] = useState(false);

  const [valorCobranca, setValorCobranca] = useState(1000);
  const [taxaAdm, setTaxaAdm] = useState(5);

  const [logs, setLogs] = useState([]);
  const pushLog = (label, detail, tone="zinc") => setLogs(l => [{ ts: fmtTime(), label, detail, tone }, ...l]);

  const canCreateContract = owner && tenant && property;
  
  const splitElegivel = useMemo(() => {
    if (!contract) return false;
    if (garantiaAtiva) return false;
    if (cpfCnpjObrigatorio && dadosInvalidos) return false;
    return true;
  }, [contract, garantiaAtiva, cpfCnpjObrigatorio, dadosInvalidos]);

  const valorMinimoValido = useMemo(() => {
    const valor = valorBaixo ? 12 : valorCobranca;
    return valor >= 15;
  }, [valorBaixo, valorCobranca]);

  const splitCriado = useMemo(() => {
    if (!charge) return false;
    if (!splitElegivel) return false;
    if (!valorMinimoValido && !splitSempreCriar) return false;
    return charge.splitTag;
  }, [charge, splitElegivel, valorMinimoValido, splitSempreCriar]);

  const prontoPraRepasse = useMemo(() => {
    if (!webhook) return false;
    if (webhookTimeout) return false;
    if (splitCancelado) return false;
    return webhook.type === "boleto_liquidado";
  }, [webhook, webhookTimeout, splitCancelado]);

  const valorLiquidoRepasse = useMemo(() => {
    if (!charge) return 0;
    const bruto = valorBaixo ? 12 : valorCobranca;
    const desconto = descontoPontualidade ? bruto * 0.05 : 0;
    const base = bruto - desconto;
    const taxaAdmValor = base * (taxaAdm / 100);
    const liquido = Math.max(base - taxaAdmValor, 0);
    if (multisplitAtivo) {
      return { total: liquido, prop: liquido * 0.8, terceiro: liquido * 0.2 };
    }
    return liquido;
  }, [charge, valorBaixo, valorCobranca, descontoPontualidade, taxaAdm, multisplitAtivo]);

  const ownerError = useMemo(() => {
    if (!owner) return null;
    if (cpfCnpjObrigatorio && !owner.cpfCnpj) return "CPF/CNPJ obrigatorio nao informado";
    if (!owner.contaPJBank) return "Dados bancarios invalidos / conta PJBank invalida";
    return null;
  }, [owner, cpfCnpjObrigatorio]);

  const flowSteps = useMemo(() => {
    return [
      {
        id: 'owner',
        label: 'Proprietario',
        subtext: 'Dados + PJBank',
        status: !owner ? 'pending' : ownerError ? 'error' : 'completed'
      },
      {
        id: 'tenant',
        label: 'Locatario',
        subtext: 'Cliente pagador',
        status: !tenant ? 'pending' : 'completed'
      },
      {
        id: 'property',
        label: 'Imovel',
        subtext: 'Unidade locada',
        status: !property ? 'pending' : 'completed'
      },
      {
        id: 'contract',
        label: 'Contrato',
        subtext: 'FL_SPLIT_CON=1',
        status: !contract ? 'pending' : garantiaAtiva ? 'error' : 'completed'
      },
      {
        id: 'charge',
        label: 'Cobranca',
        subtext: 'Tag SPLIT',
        status: !charge ? 'pending' : !splitCriado ? 'error' : 'completed'
      },
      {
        id: 'webhook',
        label: 'Webhook',
        subtext: 'boleto_liquidado',
        status: !webhook ? 'pending' : webhookTimeout ? 'error' : 'completed'
      },
      {
        id: 'repasse',
        label: 'Repasse',
        subtext: 'Valor liquido',
        status: !repasse ? 'pending' : splitCancelado ? 'error' : 'completed'
      }
    ];
  }, [owner, tenant, property, contract, charge, webhook, repasse, ownerError, garantiaAtiva, splitCriado, webhookTimeout, splitCancelado]);

  const progress = useMemo(() => {
    const items = [owner, tenant, property, contract, charge, webhook, repasse];
    const done = items.filter(Boolean).length;
    return Math.round((done / items.length) * 100);
  }, [owner, tenant, property, contract, charge, webhook, repasse]);

  const cadastrar = (tipo) => {
    const base = { id: rand(), createdAt: fmtTime() };
    
    if (tipo === "owner") {
      const temCpfCnpj = !(cpfCnpjObrigatorio && dadosInvalidos);
      const contaValida = !dadosInvalidos && temCpfCnpj;
      const o = { ...base, nome: "Proprietario(a)", contaPJBank: contaValida, cpfCnpj: temCpfCnpj };
      setOwner(o);
      
      if (!temCpfCnpj && cpfCnpjObrigatorio) {
        pushLog("Erro", "CPF/CNPJ obrigatorio nao informado.", "red");
      } else if (!contaValida) {
        pushLog("Aviso", "Conta PJBank invalida ou dados bancarios incorretos.", "amber");
      } else {
        pushLog("Cadastro", "Proprietario criado com dados validos.", "emerald");
      }
    }
    
    if (tipo === "tenant") {
      setTenant({ ...base, nome: "Locatario(a)" });
      pushLog("Cadastro", "Locatario criado.", "emerald");
    }
    
    if (tipo === "property") {
      setProperty({ ...base, nome: "Imovel" });
      pushLog("Cadastro", "Imovel criado.", "emerald");
    }
  };

  const gerarContrato = () => {
    if (!canCreateContract) return;
    const c = { id: rand(), flSplit: true, garantiaAtiva, taxaAdm };
    setContract(c);
    pushLog("Contrato", `Contrato gerado (FL_SPLIT_CON=1). Taxa admin: ${taxaAdm}%. Garantia: ${garantiaAtiva ? "ativa" : "inativa"}.`, "emerald");
  };

  const gerarCobranca = () => {
    if (!contract) return;
    const valor = valorBaixo ? 12 : valorCobranca;
    const tagSplit = splitElegivel && (valorMinimoValido || splitSempreCriar);
    const ch = { id: rand(), valor, splitTag: tagSplit, engine: novoSplitAtivo ? "novo" : "legado" };
    setCharge(ch);
    
    if (!splitElegivel) {
      pushLog("Cobranca", `Split inelegivel. Engine: ${ch.engine}`, "amber");
    } else if (!valorMinimoValido && !splitSempreCriar) {
      pushLog("Validacao", `Valor R$${valor} < R$15 - split nao criado.`, "amber");
    } else if (splitSempreCriar && !valorMinimoValido) {
      pushLog("Config", "split.semprecriar=true FORCOU criacao mesmo com valor baixo.", "purple");
    } else {
      pushLog("Cobranca", `Split criado. Engine: ${ch.engine}. Tag aplicada.`, "emerald");
    }
  };

  const liquidarBoleto = () => {
    if (!charge) return;
    if (webhookTimeout) {
      pushLog("Timeout", "Webhook timeout apos 30 segundos. Processamento manual necessario.", "red");
      return;
    }
    const event = { type: "boleto_liquidado", recebimentoId: charge.id };
    setWebhook(event);
    pushLog("Webhook", "boleto_liquidado recebido do PJBank dentro do prazo.", "sky");
  };

  const processarRepasse = () => {
    if (!charge || !webhook) return;
    
    if (splitCancelado) {
      pushLog("Erro", "Split cancelado por erro anterior. Status: CANCELADO", "red");
      setRepasse(null);
      return;
    }
    
    if (despesaIndevida) {
      pushLog("Auditoria", "ERRO: Despesas indevidas detectadas. Diferenca ERP x PJBank.", "red");
      setSplitCancelado(true);
      setRepasse(null);
      return;
    }
    
    if (!splitCriado) {
      pushLog("Cancelado", "Split nao foi criado na cobranca original.", "amber");
      return;
    }

    if (multisplitAtivo && typeof valorLiquidoRepasse === "object") {
      const { total, prop, terceiro } = valorLiquidoRepasse;
      const repData = { id: rand(), status: "confirmado", engine: charge.engine, total, prop, terceiro };
      setRepasse(repData);
      pushLog("Repasse", `Proprietario R$ ${prop.toFixed(2)} | Terceiro R$ ${terceiro.toFixed(2)} (Total: R$ ${total.toFixed(2)})`, "emerald");
    } else {
      const valor = valorLiquidoRepasse;
      const repData = { id: rand(), valor, status: "confirmado", engine: charge.engine };
      setRepasse(repData);
      pushLog("Repasse", `SUCESSO: Proprietario recebeu R$ ${valor.toFixed(2)} via ${charge.engine}.`, "emerald");
    }

    pushLog("Database", "Dados gravados na tabela SPLIT do financeiro (<licenca>-001).", "sky");
  };

  const resetar = () => {
    setOwner(null); setTenant(null); setProperty(null); setContract(null);
    setCharge(null); setWebhook(null); setRepasse(null); setLogs([]);
    setSplitCancelado(false);
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-zinc-50 to-white">
      <FlowChart 
        isOpen={flowChartOpen} 
        onToggle={() => setFlowChartOpen(!flowChartOpen)} 
        steps={flowSteps} 
      />
      
      <div className="w-full mx-auto max-w-7xl p-4 md:p-8">
        <header className="mb-6 md:mb-8">
          <h1 className="text-2xl md:text-3xl font-bold tracking-tight">SPLIT - Simulador Tecnico Completo</h1>
          <p className="text-zinc-600 mt-1">
            Baseado na investigacao real do codigo. Inclui configuracoes criticas, validacoes tecnicas e cenarios complexos descobertos na analise.
          </p>
          <div className="mt-2 text-sm text-zinc-500">
            Versao limpa - 100% compativel com todos os sistemas
          </div>
        </header>

        <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
          <div className="xl:col-span-3 space-y-4">
            <Section title="Cadastro e Contrato" subtitle="Crie as entidades basicas e ative o SPLIT">
              <div className="cards-grid">
                <StepCard 
                  step={1} 
                  title="Cadastrar Proprietario" 
                  done={!!owner && !ownerError} 
                  error={ownerError}
                  ctaLabel={owner ? "ok" : "Cadastrar"} 
                  onClick={!owner ? () => cadastrar("owner") : undefined}
                >
                  <div className="text-sm text-zinc-600">
                    Requer conta PJBank valida {cpfCnpjObrigatorio && "+ CPF/CNPJ obrigatorio"}
                  </div>
                </StepCard>
                
                <StepCard 
                  step={2} 
                  title="Cadastrar Locatario" 
                  done={!!tenant} 
                  ctaLabel={tenant ? "ok" : "Cadastrar"} 
                  onClick={!tenant ? () => cadastrar("tenant") : undefined}
                >
                  <div className="text-sm text-zinc-600">Cliente que realizara os pagamentos.</div>
                </StepCard>
                
                <StepCard 
                  step={3} 
                  title="Cadastrar Imovel" 
                  done={!!property} 
                  ctaLabel={property ? "ok" : "Cadastrar"} 
                  onClick={!property ? () => cadastrar("property") : undefined}
                >
                  <div className="text-sm text-zinc-600">Unidade locada vinculada ao contrato.</div>
                </StepCard>
              </div>
              
              <div className="mt-4 p-4 bg-zinc-50 rounded-lg">
                <h3 className="font-medium mb-2">Configuracoes do Contrato</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-zinc-600">Taxa de Administracao (%)</label>
                    <input 
                      type="number" 
                      value={taxaAdm} 
                      onChange={(e) => setTaxaAdm(Number(e.target.value))}
                      className="w-full mt-1 px-3 py-2 border border-zinc-300 rounded-lg text-sm"
                      min="0" max="20" step="0.5"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-zinc-600">Valor da Cobranca (R$)</label>
                    <input 
                      type="number" 
                      value={valorCobranca} 
                      onChange={(e) => setValorCobranca(Number(e.target.value))}
                      className="w-full mt-1 px-3 py-2 border border-zinc-300 rounded-lg text-sm"
                      min="10" max="10000" step="50"
                    />
                  </div>
                </div>
                
                <div className="mt-4">
                  <StepCard 
                    step={4} 
                    title="Gerar Contrato (FL_SPLIT_CON=1)" 
                    done={!!contract} 
                    ctaLabel={contract ? "ok" : "Gerar"} 
                    onClick={!contract && !ownerError ? gerarContrato : undefined} 
                    warning={ownerError ? `Corrija o cadastro do proprietario: ${ownerError}` : (garantiaAtiva ? "Garantia ativa impede SPLIT durante periodo de cobertura." : undefined)}
                  />
                </div>
              </div>
            </Section>

            <Section title="Cobranca, Liquidacao e Repasse" subtitle="Processamento com validacoes tecnicas">
              <div className="cards-grid">
                <StepCard 
                  step={5} 
                  title="Gerar Cobranca + Tag SPLIT" 
                  done={!!charge && splitCriado} 
                  ctaLabel={charge ? "ok" : "Gerar"} 
                  onClick={!charge ? gerarCobranca : undefined} 
                  warning={!valorMinimoValido && !splitSempreCriar ? `Valor R$${valorBaixo ? 12 : valorCobranca} < R$15 bloqueia split.` : undefined}
                  info={novoSplitAtivo ? "Engine: Services_Split_Split (novo)" : "Engine: Helpers_Repasses (legado)"}
                >
                  <div className="text-sm text-zinc-600">
                    {splitSempreCriar ? "split.semprecriar=true FORCA criacao" : "Tag SPLIT aplicada se elegivel"}
                  </div>
                </StepCard>
                
                <StepCard 
                  step={6} 
                  title="Webhook (boleto_liquidado)" 
                  done={!!webhook && !webhookTimeout} 
                  error={webhookTimeout ? "Timeout apos 30s" : null}
                  ctaLabel={webhook ? "ok" : "Receber"} 
                  onClick={!webhook ? liquidarBoleto : undefined}
                >
                  <div className="text-sm text-zinc-600">
                    PJBank para ERP (Controllers/HooksController.php)
                  </div>
                </StepCard>
                
                <StepCard 
                  step={7} 
                  title="Processar Repasse" 
                  done={!!repasse} 
                  ctaLabel={repasse ? "ok" : "Processar"} 
                  onClick={!repasse && prontoPraRepasse ? processarRepasse : undefined} 
                  error={splitCancelado ? "Split cancelado por erro" : null}
                  warning={!prontoPraRepasse ? "Aguardando webhook valido para liberar o repasse." : (despesaIndevida ? "Auditoria detectou despesas indevidas." : undefined)}
                >
                  <div className="text-sm text-zinc-600">
                    {multisplitAtivo && typeof valorLiquidoRepasse === "object"
                      ? `Liquido total: R$ ${valorLiquidoRepasse.total.toFixed(2)} | Prop: R$ ${valorLiquidoRepasse.prop.toFixed(2)} | Terceiro: R$ ${valorLiquidoRepasse.terceiro.toFixed(2)}`
                      : `Valor liquido: R$ ${Number(valorLiquidoRepasse).toFixed(2)}`
                    }
                  </div>
                </StepCard>
              </div>

              <div className="mt-4 p-6 rounded-xl bg-white border border-zinc-200 shadow-sm">
                <div className="flex items-center justify-between mb-4">
                  <div className="text-sm font-medium text-zinc-700">Progresso do Simulador</div>
                  <div className="text-sm text-zinc-500 font-mono">{progress}% concluido</div>
                </div>
                <div className="h-3 w-full bg-zinc-200 rounded-full overflow-hidden mb-4">
                  <div className="h-full bg-emerald-500 progress-bar" style={{ width: progress + "%" }} />
                </div>
                
                <div className="space-y-3">
                  <div className="flex justify-start">
                    <button 
                      onClick={resetar} 
                      className="px-4 py-2 rounded-lg border border-zinc-300 text-zinc-700 text-sm hover:bg-zinc-50 hover:border-zinc-400 transition-colors"
                    >
                      Resetar Simulacao
                    </button>
                  </div>
                  
                  <div className="flex flex-wrap gap-2">
                  {repasse && !multisplitAtivo && <Badge tone="emerald">Repasse: R$ {repasse.valor.toFixed(2)}</Badge>}
                  {repasse && multisplitAtivo && repasse.prop != null && (
                    <>
                      <Badge tone="emerald">Prop: R$ {repasse.prop.toFixed(2)}</Badge>
                      <Badge tone="purple">Terceiro: R$ {repasse.terceiro.toFixed(2)}</Badge>
                      <Badge tone="sky">Total: R$ {repasse.total.toFixed(2)}</Badge>
                    </>
                  )}
                  {charge && <Badge tone={splitCriado ? "emerald" : "amber"}>Tag SPLIT: {splitCriado ? "aplicada" : "nao aplicada"}</Badge>}
                  {charge && <Badge tone="purple">Engine: {charge.engine}</Badge>}
                  {repasse && <Badge tone="sky">Status: {repasse.status}</Badge>}
                  {splitCancelado && <Badge tone="red">CANCELADO</Badge>}

                  {!webhook && charge && <Badge tone="amber">aguardando webhook</Badge>}
                  {webhook && webhookTimeout && <Badge tone="red">timeout webhook</Badge>}
                  {webhook && !webhookTimeout && !splitCancelado && <Badge tone="sky">webhook ok</Badge>}
                  </div>
                </div>
              </div>
            </Section>
          </div>

          <div className="space-y-4">
            <Section title="[CONFIG] Configuracoes Criticas do Sistema" subtitle="Descobertas na investigacao tecnica">
              <div className="space-y-2">
                <Toggle 
                  label="novosplit.ativo" 
                  checked={novoSplitAtivo} 
                  onChange={setNovoSplitAtivo} 
                  hint="Define qual engine usar: novo (Services_Split_Split) vs legado (Helpers_Repasses)" 
                  critical={true}
                />
                <Toggle 
                  label="split.semprecriar" 
                  checked={splitSempreCriar} 
                  onChange={setSplitSempreCriar} 
                  hint="Forca criacao do SPLIT mesmo em cenarios nao ideais (ignora valor minimo)" 
                  critical={true}
                />
                <Toggle 
                  label="multisplit.ativo" 
                  checked={multisplitAtivo} 
                  onChange={setMultisplitAtivo} 
                  hint="Divide o liquido (80% proprietario / 20% terceiro) e exibe nos badges"
                />
              </div>
            </Section>

            <Section title="[REGRAS] Cenarios e Regras de Negocio" subtitle="Simulacoes baseadas no codigo real">
              <div className="space-y-2">
                <Toggle 
                  label="pessoas.travarcpfproprietario" 
                  checked={cpfCnpjObrigatorio} 
                  onChange={setCpfCnpjObrigatorio} 
                  hint="CPF/CNPJ obrigatorio para proprietario (config critica para SPLIT)" 
                  critical={true}
                />
                <Toggle 
                  label="Garantia ativa" 
                  checked={garantiaAtiva} 
                  onChange={setGarantiaAtiva} 
                  hint="Bloqueia SPLIT durante periodo de garantia ativa" 
                />
                <Toggle 
                  label="Dados bancarios/CPF invalidos" 
                  checked={dadosInvalidos} 
                  onChange={setDadosInvalidos} 
                  hint="Dados PJBank invalidos impedem criacao do split" 
                />
                <Toggle 
                  label="Valor < R$15,00" 
                  checked={valorBaixo} 
                  onChange={setValorBaixo} 
                  hint="Valor minimo hard-coded (VALOR_MINIMO_REPASSE)" 
                />
                <Toggle 
                  label="Desconto de pontualidade" 
                  checked={descontoPontualidade} 
                  onChange={setDescontoPontualidade} 
                  hint="Aplica desconto antes do calculo (repasse.descontopontualidade)" 
                />
                <Toggle 
                  label="Despesas indevidas" 
                  checked={despesaIndevida} 
                  onChange={setDespesaIndevida} 
                  hint="Gera diferenca ERP x PJBank, cancela split e requer auditoria" 
                />
                <Toggle 
                  label="Webhook timeout" 
                  checked={webhookTimeout} 
                  onChange={setWebhookTimeout} 
                  hint="Timeout no webhook PJBank apos 30 segundos" 
                />
              </div>
            </Section>

            <Section title="[LOGS] Logs da Simulacao" subtitle="Timeline tecnica detalhada">
              <div className="space-y-1 max-h-80 overflow-auto pr-1">
                {logs.length === 0 && (
                  <div className="text-sm text-zinc-500">
                    Sem eventos ainda. Execute as acoes para ver os logs tecnicos.
                  </div>
                )}
                {logs.map((l, i) => <LogRow key={i} {...l} />)}
              </div>
            </Section>

            <Section title="[TECH] Detalhes Tecnicos">
              <div className="text-xs text-zinc-600 space-y-2">
                <div><strong>Tabelas:</strong></div>
                <ul className="list-disc pl-4 space-y-1">
                  <li><code>&lt;licenca&gt;-001.SPLIT</code> - Fonte da verdade (financeiro)</li>
                  <li><code>app26_&lt;licenca&gt;-001.SPLIT_*</code> - Logs e historico (apps)</li>
                </ul>
                
                <div><strong>Arquivos criticos:</strong></div>
                <ul className="list-disc pl-4 space-y-1">
                  <li><code>Services/Cobrancas/Split.php</code> - Logica principal</li>
                  <li><code>Controllers/HooksController.php</code> - Webhooks PJBank</li>
                  <li><code>Models/ImobiliariaConf.php</code> - Configs que afetam SPLIT</li>
                </ul>
                
                <div><strong>Validacoes:</strong></div>
                <ul className="list-disc pl-4 space-y-1">
                  <li>Valor minimo: R$ 15,00</li>
                  <li>CPF/CNPJ obrigatorio (quando ativo)</li>
                  <li>Conta bancaria valida no PJBank</li>
                  <li>FL_SPLIT_CON = 1 no contrato</li>
                  <li>Sem garantia ativa</li>
                </ul>
              </div>
            </Section>
          </div>
        </div>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
  </script>
</body>
</html>
